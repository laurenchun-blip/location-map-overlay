<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Heatmap Prototype – Search + Intensity + Legend</title>

    <link
      href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=close"
    />

    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        overflow: hidden;
        font-family: system-ui, sans-serif;
        background: #f5f5f5;
      }
      #map {
        position: absolute;
        inset: 0;
      }

      /* Ellipse overlay */
      #ellipseLayer {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
        overflow: visible;
      }
      circle {
        fill: rgba(0, 120, 255, 0.18);
        stroke: rgba(0, 120, 255, 0.9);
        stroke-width: 2;
      }
      text.miles-label {
        fill: #0b5bd7;
        font-size: 12px;
        font-weight: 600;
        paint-order: stroke;
        stroke: #fff;
        stroke-width: 3px;
      }

      #dragHit {
        fill: rgba(0, 0, 0, 0.001);
        pointer-events: none;
        cursor: grab;
      }
      #dragHit.active {
        pointer-events: auto;
      }
      #dragHit.dragging {
        cursor: grabbing;
      }

      #interaction {
        position: absolute;
        inset: 0;
        z-index: 25;
        pointer-events: none;
      }
      #dragHandle {
        position: absolute;
        border-radius: 50%;
        background: #fff;
        border: 2px solid #0078ff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        transform: translate(-50%, -50%);
        cursor: grab;
        pointer-events: auto;
        touch-action: none;
      }

      /* Top UI */
      #uiContainer {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px;
      }
      #searchBar,
      #zoomPanel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(6px);
      }
      #searchInput {
        border: none;
        outline: none;
        background: transparent;
        font-size: 15px;
        flex: 1;
      }
      #searchBtn,
      #exitBtn {
        border: none;
        border-radius: 8px;
        padding: 6px 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      #searchBtn {
        background: #0078ff;
        color: white;
      }
      #searchBtn:hover {
        background: #005ed1;
      }
      #exitBtn {
        background: #eee;
      }
      #exitBtn:hover {
        background: #ccc;
      }
      #zoomPanel {
        justify-content: space-between;
      }
      #zoomSlider {
        flex: 1;
        height: 28px;
      }
      #zoomValue {
        font-size: 14px;
        color: #333;
        width: 40px;
        text-align: right;
      }

      /* Bottom overlay card */
      #bottomOverlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 40;
        background: #fff;
        color: #111;
        text-align: center;
        font-size: 18px;
        font-weight: 500;
        padding: 24px 48px;
        border-top-left-radius: 24px;
        border-top-right-radius: 24px;
        box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(6px);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      #statusText {
        font-size: 18px;
        font-weight: 600;
      }
      #radiusControls {
        display: none;
        flex-direction: column;
        align-items: center;
        width: 100%;
        gap: 12px;
        font-size: 15px;
      }
      #radiusSlider {
        width: 80%;
      }
      #radiusValue {
        width: 80px;
        border: 1px solid rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 4px 6px;
        text-align: right;
      }

      #selectAreaBtn {
        margin-top: 8px;
        background: #0078ff;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 500;
        padding: 14px 24px;
        width: 100%;
        max-width: 320px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        cursor: pointer;
      }

      /* Heatmap legend */
      #legend {
        position: absolute;
        bottom: 110px;
        right: 12px;
        z-index: 45;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 13px;
        color: #333;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.2);
      }
      #legend .bar {
        width: 140px;
        height: 10px;
        margin: 6px 0;
        background: linear-gradient(
          to right,
          #00d0a8,
          #0096ff,
          #005aff,
          #ff4646
        );
        border-radius: 6px;
      }
      #legend .labels {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <svg id="ellipseLayer">
      <circle id="radiusCircle" cx="-1000" cy="-1000" r="0"></circle>
      <text id="milesLabel" class="miles-label" x="-1000" y="-1000">0 mi</text>
      <circle id="dragHit" cx="-1000" cy="-1000" r="0"></circle>
    </svg>

    <div id="interaction"><div id="dragHandle" hidden></div></div>

    <div id="uiContainer">
      <div id="searchBar">
        <input id="searchInput" type="text" placeholder="Search city..." />
        <button id="searchBtn">Go</button>
        <button id="exitBtn" aria-label="Clear selection">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div id="zoomPanel">
        <label for="zoomSlider">Zoom</label>
        <input
          id="zoomSlider"
          type="range"
          min="1"
          max="14"
          step="0.1"
          value="4"
        />
        <span id="zoomValue">4.0</span>
      </div>
    </div>

    <div id="bottomOverlay">
      <div id="statusText">Search locations to see results</div>
      <div id="radiusControls">
        <label for="radiusSlider">Radius (mi):</label>
        <input
          id="radiusSlider"
          type="range"
          min="0"
          max="100"
          step="1"
          value="15"
        />
        <input
          id="radiusValue"
          type="number"
          min="0.1"
          max="50"
          step="0.1"
          value="1.5"
        />
        <button id="selectAreaBtn" disabled>Select area</button>
      </div>
    </div>

    <div id="legend">
      <div>Heat intensity</div>
      <div class="bar"></div>
      <div class="labels"><span>Low</span><span>High</span></div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <script>
      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          sources: {
            osm: {
              type: "raster",
              tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
              tileSize: 256,
            },
          },
          layers: [{ id: "osm", type: "raster", source: "osm" }],
        },
        center: [-98.5, 39.8],
        zoom: 4,
      });

      const circleEl = document.getElementById("radiusCircle"),
        milesLabelEl = document.getElementById("milesLabel"),
        dragHit = document.getElementById("dragHit"),
        dragHandle = document.getElementById("dragHandle"),
        radiusControls = document.getElementById("radiusControls"),
        radiusSlider = document.getElementById("radiusSlider"),
        radiusInput = document.getElementById("radiusValue"),
        searchInput = document.getElementById("searchInput"),
        searchBtn = document.getElementById("searchBtn"),
        exitBtn = document.getElementById("exitBtn"),
        selectAreaBtn = document.getElementById("selectAreaBtn"),
        statusText = document.getElementById("statusText");

      const signsData = [
        { lng: -118.268, lat: 34.0407, impressions: 120000 },
        { lng: -118.2505, lat: 34.0535, impressions: 180000 },
        { lng: -118.2812, lat: 34.045, impressions: 95000 },
        { lng: -122.2718, lat: 37.812, impressions: 60000 },
        { lng: -122.256, lat: 37.801, impressions: 80000 },
        { lng: -122.24, lat: 37.795, impressions: 50000 },
        { lng: -87.635, lat: 41.885, impressions: 150000 },
        { lng: -87.62, lat: 41.87, impressions: 110000 },
        { lng: -87.645, lat: 41.9, impressions: 175000 },
        { lng: -87.9005, lat: 42.04, impressions: 30000 },
        { lng: -87.875, lat: 42.02, impressions: 42000 },
        { lng: -87.91, lat: 42.05, impressions: 35000 },
        { lng: -111.9, lat: 40.77, impressions: 70000 },
        { lng: -111.86, lat: 40.745, impressions: 54000 },
        { lng: -111.905, lat: 40.78, impressions: 82000 },
      ];

      map.once("styledata", () => {
        const geojson = {
          type: "FeatureCollection",
          features: signsData.map((s) => ({
            type: "Feature",
            properties: { impressions: s.impressions },
            geometry: { type: "Point", coordinates: [s.lng, s.lat] },
          })),
        };
        map.addSource("signs", { type: "geojson", data: geojson });
        map.addLayer({
          id: "signs-heat",
          type: "heatmap",
          source: "signs",
          paint: {
            "heatmap-weight": [
              "interpolate",
              ["linear"],
              ["get", "impressions"],
              30000,
              0.2,
              200000,
              1.0,
            ],
            "heatmap-radius": [
              "interpolate",
              ["linear"],
              ["zoom"],
              5,
              20,
              11,
              40,
              14,
              60,
            ],
            "heatmap-intensity": [
              "interpolate",
              ["linear"],
              ["zoom"],
              5,
              1.0,
              11,
              1.6,
              14,
              2.0,
            ],
            "heatmap-color": [
              "interpolate",
              ["linear"],
              ["heatmap-density"],
              0,
              "rgba(0,0,0,0)",
              0.1,
              "rgba(0,208,168,0.4)",
              0.3,
              "rgba(0,150,255,0.65)",
              0.6,
              "rgba(0,90,255,0.75)",
              0.85,
              "rgba(255,70,70,0.9)",
              1.0,
              "rgba(255,20,20,0.95)",
            ],
            "heatmap-opacity": 0.95,
          },
        });
      });

      let activePoint = null;
      function flyTo(lat, lng) {
        map.flyTo({ center: [lng, lat], zoom: 11 });
      }
      function setActive(lat, lng) {
        activePoint = { lat, lng };
        radiusControls.style.display = "flex";
        updateEllipse();
        updateCounts();
      }

      searchBtn.onclick = () => handleSearch();
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleSearch();
      });

      function handleSearch() {
        const q = searchInput.value.trim().toLowerCase();
        const cityCenters = {
          "los angeles": { lat: 34.0522, lng: -118.2437 },
          oakland: { lat: 37.8044, lng: -122.2712 },
          chicago: { lat: 41.8781, lng: -87.6298 },
          "des plaines": { lat: 42.0334, lng: -87.8834 },
          "salt lake city": { lat: 40.7608, lng: -111.891 },
        };
        const center = cityCenters[q];
        if (center) {
          flyTo(center.lat, center.lng);
          setActive(center.lat, center.lng);
        } else
          alert(
            "Try searching: Los Angeles, Oakland, Chicago, Des Plaines, Salt Lake City."
          );
      }

      exitBtn.onclick = () => {
        activePoint = null;
        circleEl.setAttribute("r", 0);
        milesLabelEl.textContent = "";
        radiusControls.style.display = "none";
        dragHandle.hidden = true;
        dragHit.classList.remove("active");
        statusText.textContent = "Search locations to see results";
      };

      function toRad(d) {
        return (d * Math.PI) / 180;
      }
      function metersBetween(a, b) {
        const R = 6371008.8,
          dLat = toRad(b.lat - a.lat),
          dLng = toRad(b.lng - a.lng),
          lat1 = toRad(a.lat),
          lat2 = toRad(b.lat);
        const h =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(h));
      }
      function milesBetween(a, b) {
        return metersBetween(a, b) / 1609.344;
      }
      function milesToPixels(center, miles) {
        const m = miles * 1609.344,
          canvas = map.getCanvas(),
          ll1 = map.unproject([canvas.width / 2, canvas.height / 2]),
          ll2 = map.unproject([canvas.width / 2 + 1, canvas.height / 2]);
        return (
          m /
          metersBetween(
            { lat: ll1.lat, lng: ll1.lng },
            { lat: ll2.lat, lng: ll2.lng }
          )
        );
      }

      function handleSizeForPx(px) {
        const min = 16,
          max = 36;
        const t = Math.max(0, Math.min(1, (px - 40) / (300 - 40)));
        return Math.round(min + t * (max - min));
      }
      function positionHandle() {
        if (!activePoint) {
          dragHandle.hidden = true;
          return;
        }
        const pos = map.project([activePoint.lng, activePoint.lat]);
        dragHandle.style.left = pos.x + "px";
        dragHandle.style.top = pos.y + "px";
        dragHandle.hidden = false;
      }

      function updateEllipse() {
        if (!activePoint) return;
        const pos = map.project([activePoint.lng, activePoint.lat]);
        const miles = parseFloat(radiusInput.value) || 0.1,
          px = milesToPixels(activePoint, miles);
        circleEl.setAttribute("cx", pos.x);
        circleEl.setAttribute("cy", pos.y);
        circleEl.setAttribute("r", px);
        milesLabelEl.textContent = `${miles.toFixed(1)} mi`;
        milesLabelEl.setAttribute("x", pos.x);
        milesLabelEl.setAttribute("y", pos.y - px - 10);
        dragHit.setAttribute("cx", pos.x);
        dragHit.setAttribute("cy", pos.y);
        dragHit.setAttribute("r", px);
        dragHit.classList.add("active");
        const size = handleSizeForPx(px);
        dragHandle.style.width = size + "px";
        dragHandle.style.height = size + "px";
        positionHandle();
        updateSelectButtonState();
      }

      let isDraggingHit = false;
      function screenToLngLat(x, y) {
        const r = map.getCanvasContainer().getBoundingClientRect();
        return map.unproject([x - r.left, y - r.top]);
      }
      dragHit.onpointerdown = (e) => {
        if (!activePoint) return;
        isDraggingHit = true;
        dragHit.classList.add("dragging");
        map.dragPan.disable();
        map.scrollZoom.disable();
        window.addEventListener("pointermove", moveHit);
        window.addEventListener("pointerup", upHit);
        e.preventDefault();
      };
      function moveHit(e) {
        if (!isDraggingHit) return;
        const ll = screenToLngLat(e.clientX, e.clientY);
        activePoint.lng = ll.lng;
        activePoint.lat = ll.lat;
        updateEllipse();
        updateCounts();
      }
      function upHit() {
        if (!isDraggingHit) return;
        isDraggingHit = false;
        dragHit.classList.remove("dragging");
        map.dragPan.enable();
        map.scrollZoom.enable();
        window.removeEventListener("pointermove", moveHit);
        window.removeEventListener("pointerup", upHit);
      }

      function countSignsInSelection() {
        if (!activePoint) return { count: 0, impressions: 0 };
        const miles = parseFloat(radiusInput.value) || 0.1;
        let c = 0,
          i = 0;
        for (const s of signsData) {
          if (milesBetween(activePoint, { lat: s.lat, lng: s.lng }) <= miles) {
            c++;
            i += s.impressions;
          }
        }
        return { count: c, impressions: i };
      }
      function updateSelectButtonState() {
        const { count } = activePoint ? countSignsInSelection() : { count: 0 };
        selectAreaBtn.disabled = count === 0;
      }
      function updateSelectionStatus() {
        const { count, impressions } = countSignsInSelection();
        statusText.textContent = `${impressions.toLocaleString()} impressions in selection`;
        //   statusText.textContent = `${count} sign${
        //   count !== 1 ? "s" : ""
        // } in selection · ${impressions.toLocaleString()} impressions`;
      }
      function updateCounts() {
        if (activePoint) updateSelectionStatus();
      }
      radiusSlider.oninput = () => {
        radiusInput.value = (radiusSlider.value / 2).toFixed(1);
        updateEllipse();
        updateCounts();
      };
      radiusInput.onchange = () => {
        updateEllipse();
        updateCounts();
      };
      selectAreaBtn.onclick = () => {
        const { count, impressions } = countSignsInSelection();
        alert(
          `Selected ${count} signs (${impressions.toLocaleString()} impressions)`
        );
      };
    </script>
  </body>
</html>
