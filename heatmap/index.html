<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Heatmap Prototype – CPM + Impressions</title>
    <link
      href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        overflow: hidden;
        font-family: system-ui, sans-serif;
      }
      #map {
        position: absolute;
        inset: 0;
      }
      #ellipseLayer {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: visible;
        pointer-events: none;
      }
      circle#radiusCircle {
        fill: rgba(0, 120, 255, 0.18);
        stroke: rgba(0, 120, 255, 0.9);
        stroke-width: 2;
      }
      text.miles-label {
        fill: #0b5bd7;
        font-size: 12px;
        font-weight: 600;
        paint-order: stroke;
        stroke: #fff;
        stroke-width: 3px;
      }
      #dragHit {
        fill: rgba(0, 0, 0, 0.001);
        cursor: grab;
        pointer-events: auto;
      }
      #dragHit.dragging {
        cursor: grabbing;
      }
      #uiContainer {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px;
      }
      #searchBar {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      #searchInput {
        border: none;
        outline: none;
        background: transparent;
        font-size: 15px;
        flex: 1;
      }
      #searchBtn {
        border: none;
        border-radius: 8px;
        padding: 6px 10px;
        background: #0078ff;
        color: #fff;
        cursor: pointer;
      }
      #searchBtn:hover {
        background: #005ed1;
      }
      #bottomOverlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 40;
        background: #fff;
        text-align: center;
        font-size: 18px;
        font-weight: 500;
        padding: 16px;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      #statusText {
        font-size: 16px;
        font-weight: 600;
      }
      #radiusControls {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-size: 15px;
      }
      #radiusSlider {
        width: 80%;
      }
      #radiusValue {
        width: 80px;
        border: 1px solid rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 4px 6px;
        text-align: right;
      }
      #selectAreaBtn {
        background: #0078ff;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 500;
        padding: 12px 20px;
        width: 100%;
        max-width: 300px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <svg id="ellipseLayer">
      <circle id="dragHit" cx="-1000" cy="-1000" r="0"></circle>
      <circle id="radiusCircle" cx="-1000" cy="-1000" r="0"></circle>
      <text id="milesLabel" class="miles-label" x="-1000" y="-1000">0 mi</text>
    </svg>

    <div id="uiContainer">
      <div id="searchBar">
        <input id="searchInput" type="text" placeholder="Search city..." />
        <button id="searchBtn">Go</button>
      </div>
    </div>

    <div id="bottomOverlay">
      <div id="statusText">Search a location to begin</div>
      <div id="radiusControls">
        <label for="radiusSlider">Radius (mi):</label>
        <input
          id="radiusSlider"
          type="range"
          min="0.1"
          max="20"
          step="0.1"
          value="3"
        />
        <input
          id="radiusValue"
          type="number"
          min="0.1"
          max="20"
          step="0.1"
          value="3"
        />
        <button id="selectAreaBtn" disabled>Select area</button>
      </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <script>
      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          sources: {
            osm: {
              type: "raster",
              tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
              tileSize: 256,
            },
          },
          layers: [{ id: "osm", type: "raster", source: "osm" }],
        },
        center: [-98.5, 39.8],
        zoom: 4,
      });

      const circleEl = document.getElementById("radiusCircle"),
        milesLabelEl = document.getElementById("milesLabel"),
        dragHit = document.getElementById("dragHit"),
        radiusControls = document.getElementById("radiusControls"),
        radiusSlider = document.getElementById("radiusSlider"),
        radiusInput = document.getElementById("radiusValue"),
        searchInput = document.getElementById("searchInput"),
        searchBtn = document.getElementById("searchBtn"),
        selectAreaBtn = document.getElementById("selectAreaBtn"),
        statusText = document.getElementById("statusText");

      let activePoint = null;
      let isDragging = false;

      // Add CPM values to each sign
      const signsData = [
        { lng: -118.268, lat: 34.0407, impressions: 120000, cpm: 7.5 },
        { lng: -118.2505, lat: 34.0535, impressions: 180000, cpm: 6.8 },
        { lng: -118.2812, lat: 34.045, impressions: 95000, cpm: 8.2 },
        { lng: -122.2718, lat: 37.812, impressions: 60000, cpm: 5.6 },
        { lng: -122.256, lat: 37.801, impressions: 80000, cpm: 5.8 },
        { lng: -122.24, lat: 37.795, impressions: 50000, cpm: 6.0 },
        { lng: -87.635, lat: 41.885, impressions: 150000, cpm: 7.1 },
        { lng: -87.62, lat: 41.87, impressions: 110000, cpm: 6.9 },
        { lng: -87.645, lat: 41.9, impressions: 175000, cpm: 7.2 },
        { lng: -87.9005, lat: 42.04, impressions: 30000, cpm: 5.2 },
        { lng: -87.875, lat: 42.02, impressions: 42000, cpm: 5.5 },
        { lng: -87.91, lat: 42.05, impressions: 35000, cpm: 5.1 },
        { lng: -111.9, lat: 40.77, impressions: 70000, cpm: 6.3 },
        { lng: -111.86, lat: 40.745, impressions: 54000, cpm: 6.6 },
        { lng: -111.905, lat: 40.78, impressions: 82000, cpm: 6.1 },
      ];

      map.on("load", () => {
        const geojson = {
          type: "FeatureCollection",
          features: signsData.map((s) => ({
            type: "Feature",
            properties: { impressions: s.impressions, cpm: s.cpm },
            geometry: { type: "Point", coordinates: [s.lng, s.lat] },
          })),
        };
        map.addSource("signs", { type: "geojson", data: geojson });
        map.addLayer({
          id: "signs-heat",
          type: "heatmap",
          source: "signs",
          paint: {
            "heatmap-weight": [
              "interpolate",
              ["linear"],
              ["get", "impressions"],
              30000,
              0.2,
              200000,
              1.0,
            ],
            "heatmap-radius": [
              "interpolate",
              ["linear"],
              ["zoom"],
              5,
              20,
              11,
              40,
              14,
              60,
            ],
            "heatmap-intensity": [
              "interpolate",
              ["linear"],
              ["zoom"],
              5,
              1.0,
              11,
              1.6,
              14,
              2.0,
            ],
            "heatmap-color": [
              "interpolate",
              ["linear"],
              ["heatmap-density"],
              0,
              "rgba(0,0,0,0)",
              0.2,
              "rgba(0,150,255,0.4)",
              0.5,
              "rgba(0,90,255,0.7)",
              0.8,
              "rgba(255,70,70,0.9)",
            ],
            "heatmap-opacity": 0.9,
          },
        });
      });

      const toRad = (d) => (d * Math.PI) / 180;
      function metersBetween(a, b) {
        const R = 6371008.8,
          dLat = toRad(b.lat - a.lat),
          dLng = toRad(b.lng - a.lng),
          lat1 = toRad(a.lat),
          lat2 = toRad(b.lat);
        const h =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(h));
      }
      function milesBetween(a, b) {
        return metersBetween(a, b) / 1609.344;
      }
      function milesToPixels(center, miles) {
        const m = miles * 1609.344,
          canvas = map.getCanvas(),
          ll1 = map.unproject([canvas.width / 2, canvas.height / 2]),
          ll2 = map.unproject([canvas.width / 2 + 1, canvas.height / 2]);
        return (
          m /
          metersBetween(
            { lat: ll1.lat, lng: ll1.lng },
            { lat: ll2.lat, lng: ll2.lng }
          )
        );
      }

      function getSelectionStats(center, miles) {
        let count = 0,
          totalImpressions = 0,
          totalCpm = 0;
        for (const s of signsData) {
          const d = milesBetween(center, { lat: s.lat, lng: s.lng });
          if (d <= miles) {
            count++;
            totalImpressions += s.impressions;
            totalCpm += s.cpm;
          }
        }
        const avgCpm = count ? totalCpm / count : 0;
        return { count, totalImpressions, avgCpm };
      }

      function updateEllipse() {
        if (!activePoint) return;
        const pos = map.project([activePoint.lng, activePoint.lat]);
        const miles = parseFloat(radiusInput.value) || 0.1;
        const px = milesToPixels(activePoint, miles);
        circleEl.setAttribute("cx", pos.x);
        circleEl.setAttribute("cy", pos.y);
        circleEl.setAttribute("r", px);
        dragHit.setAttribute("cx", pos.x);
        dragHit.setAttribute("cy", pos.y);
        dragHit.setAttribute("r", px);
        milesLabelEl.textContent = `${miles.toFixed(1)} mi`;
        milesLabelEl.setAttribute("x", pos.x);
        milesLabelEl.setAttribute("y", pos.y - px - 10);
        const { totalImpressions, avgCpm } = getSelectionStats(
          activePoint,
          miles
        );
        statusText.textContent = `${totalImpressions.toLocaleString()} total impressions · Avg CPM $${avgCpm.toFixed(
          2
        )}`;
      }

      radiusSlider.oninput = () => {
        radiusInput.value = radiusSlider.value;
        updateEllipse();
      };
      radiusInput.onchange = () => {
        radiusSlider.value = radiusInput.value;
        updateEllipse();
      };

      const cityConfig = {
        "los angeles": { lat: 34.0522, lng: -118.2437 },
        oakland: { lat: 37.8044, lng: -122.2712 },
        chicago: { lat: 41.8781, lng: -87.6298 },
        "des plaines": { lat: 42.0334, lng: -87.8834 },
        "salt lake city": { lat: 40.7608, lng: -111.891 },
        default: { lat: 39.8, lng: -98.5 },
      };

      searchBtn.onclick = handleSearch;
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleSearch();
      });

      function handleSearch() {
        const q = searchInput.value.trim().toLowerCase();
        const cfg = cityConfig[q] || cityConfig.default;
        const defaultRadius = 3.0;
        radiusInput.value = defaultRadius;
        radiusSlider.value = defaultRadius;
        radiusControls.style.display = "flex";
        selectAreaBtn.disabled = false;
        map.flyTo({ center: [cfg.lng, cfg.lat], zoom: 11 });
        map.once("moveend", () => {
          activePoint = { lat: cfg.lat, lng: cfg.lng };
          updateEllipse();
        });
      }

      map.on("move", () => {
        if (activePoint && !isDragging) updateEllipse();
      });
      window.addEventListener("resize", () => {
        if (activePoint) updateEllipse();
      });

      dragHit.addEventListener("pointerdown", (e) => {
        if (!activePoint) return;
        isDragging = true;
        dragHit.classList.add("dragging");
        map.dragPan.disable();
        window.addEventListener("pointermove", onDrag);
        window.addEventListener("pointerup", stopDrag, { once: true });
      });

      function onDrag(e) {
        const rect = map.getCanvasContainer().getBoundingClientRect();
        const x = e.clientX - rect.left,
          y = e.clientY - rect.top;
        const ll = map.unproject([x, y]);
        activePoint = { lat: ll.lat, lng: ll.lng };
        updateEllipse();
      }

      function stopDrag() {
        isDragging = false;
        dragHit.classList.remove("dragging");
        map.dragPan.enable();
        window.removeEventListener("pointermove", onDrag);
      }

      selectAreaBtn.onclick = () => {
        const miles = parseFloat(radiusInput.value);
        const { totalImpressions, avgCpm } = getSelectionStats(
          activePoint,
          miles
        );
        alert(
          `Selected ${miles.toFixed(
            1
          )} mile radius with ${totalImpressions.toLocaleString()} impressions · Avg CPM $${avgCpm.toFixed(
            2
          )}`
        );
      };
    </script>
  </body>
</html>
